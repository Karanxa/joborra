<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joborra - Employer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50">
    <div x-data="employerDashboard()" x-init="init()">
        <!-- Navigation -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-blue-600">Joborra</h1>
                        <span class="ml-2 text-sm text-gray-500">Employer Dashboard</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-700" x-text="user?.full_name"></span>
                        <span class="text-xs text-gray-500" x-text="user?.company_name"></span>
                        <button @click="logout()" class="text-sm text-red-600 hover:text-red-800">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button @click="activeTab = 'jobs'" 
                            :class="activeTab === 'jobs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        My Job Postings <span x-show="myJobs.length > 0" x-text="`(${myJobs.length})`" class="text-xs"></span>
                    </button>
                    <button @click="activeTab = 'create'" 
                            :class="activeTab === 'create' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        Post New Job
                    </button>
                    <button @click="activeTab = 'browse'" 
                            :class="activeTab === 'browse' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        Browse All Jobs
                    </button>
                </div>
            </div>
        </div>

        <!-- My Jobs Tab -->
        <div x-show="activeTab === 'jobs'" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div x-show="myJobs.length === 0" class="text-center py-12">
                <div class="text-gray-500 mb-4">You haven't posted any jobs yet.</div>
                <button @click="activeTab = 'create'" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Post Your First Job
                </button>
            </div>

            <div class="grid gap-6">
                <template x-for="job in myJobs" :key="job.id">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900" x-text="job.title"></h3>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Joborra Job</span>
                                    <span x-show="job.visa_sponsorship" class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Visa Friendly</span>
                                    <span x-show="job.international_student_friendly" class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">Student Friendly</span>
                                    <span :class="job.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                          class="px-2 py-1 text-xs rounded-full" x-text="job.is_active ? 'Active' : 'Inactive'"></span>
                                </div>
                                <p class="text-gray-600 mb-2" x-text="user?.company_name || 'Your Company'"></p>
                                <p class="text-sm text-gray-500 mb-2" x-text="job.location"></p>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span x-show="job.employment_type" x-text="job.employment_type"></span>
                                    <span x-show="job.salary_min && job.salary_max" 
                                          x-text="`$${job.salary_min}k - $${job.salary_max}k AUD`"></span>
                                    <span class="text-xs">Posted: <span x-text="new Date(job.scraped_at).toLocaleDateString()"></span></span>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4">
                                <button @click="editJob(job)" 
                                        class="px-3 py-1 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded text-sm font-medium">
                                    Edit
                                </button>
                                <button @click="toggleJobStatus(job)" 
                                        :class="job.is_active ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'"
                                        class="px-3 py-1 rounded text-sm font-medium">
                                    <span x-text="job.is_active ? 'Deactivate' : 'Activate'"></span>
                                </button>
                                <button @click="deleteJob(job.id)" 
                                        class="px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded text-sm font-medium">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div x-show="job.description" class="mt-4">
                            <p class="text-gray-700 text-sm" x-text="job.description?.substring(0, 300) + (job.description?.length > 300 ? '...' : '')"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Create Job Tab -->
        <div x-show="activeTab === 'create'" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Post a New Job</h2>
                
                <form @submit.prevent="createJob()" class="space-y-6">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                            <input x-model="jobForm.title" type="text" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Employment Type</label>
                            <select x-model="jobForm.employment_type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select...</option>
                                <option value="full-time">Full-time</option>
                                <option value="part-time">Part-time</option>
                                <option value="contract">Contract</option>
                                <option value="internship">Internship</option>
                                <option value="graduate">Graduate Program</option>
                            </select>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                            <input x-model="jobForm.city" type="text" placeholder="e.g., Sydney"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <select x-model="jobForm.state"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select...</option>
                                <option value="NSW">NSW</option>
                                <option value="VIC">VIC</option>
                                <option value="QLD">QLD</option>
                                <option value="WA">WA</option>
                                <option value="SA">SA</option>
                                <option value="TAS">TAS</option>
                                <option value="ACT">ACT</option>
                                <option value="NT">NT</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="jobForm.remote_option"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Remote Work Available</span>
                            </label>
                        </div>
                    </div>

                    <!-- Salary -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Salary (AUD thousands)</label>
                            <input x-model="jobForm.salary_min" type="number" min="0" placeholder="e.g., 60"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Salary (AUD thousands)</label>
                            <input x-model="jobForm.salary_max" type="number" min="0" placeholder="e.g., 80"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Job Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label>
                        <textarea x-model="jobForm.description" rows="8" required
                                  placeholder="Describe the role, responsibilities, requirements, and what makes this position great for international students..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- Skills -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Required Skills (comma-separated)</label>
                            <input x-model="requiredSkillsText" type="text" placeholder="JavaScript, React, Node.js"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Skills (comma-separated)</label>
                            <input x-model="preferredSkillsText" type="text" placeholder="AWS, Docker, TypeScript"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Student-Friendly Options -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">International Student Support</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" x-model="jobForm.visa_sponsorship"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <div class="ml-3">
                                    <div class="font-medium text-gray-900">Visa Sponsorship Available</div>
                                    <div class="text-sm text-gray-500">We can sponsor work visas for qualified candidates</div>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" x-model="jobForm.international_student_friendly"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <div class="ml-3">
                                    <div class="font-medium text-gray-900">International Student Friendly</div>
                                    <div class="text-sm text-gray-500">Open to students on student visas</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div x-show="error" class="text-red-600 text-sm" x-text="error"></div>

                    <div class="flex items-center space-x-4">
                        <span x-text="'Welcome, ' + user.full_name" class="text-gray-700"></span>
                        <a href="/dashboard/employer-profile.html" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-building mr-2"></i>Company Profile
                        </a>
                        <button @click="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" @click="resetForm()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Reset
                        </button>
                        <button type="submit" :disabled="loading"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-show="!loading">Post Job</span>
                            <span x-show="loading">Posting...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Browse Jobs Tab (similar to student dashboard but read-only) -->
        <div x-show="activeTab === 'browse'" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Browse All Jobs on Joborra</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <input x-model="browseFilters.search" @input="debounceBrowseSearch()" type="text" placeholder="Job title, company..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <select x-model="browseFilters.location" @change="loadAllJobs()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Locations</option>
                            <option value="Sydney">Sydney</option>
                            <option value="Melbourne">Melbourne</option>
                            <option value="Brisbane">Brisbane</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Source</label>
                        <select x-model="browseFilters.source" @change="loadAllJobs()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Sources</option>
                            <option value="joborra">Joborra Jobs</option>
                            <option value="adzuna">Adzuna</option>
                            <option value="greenhouse">Greenhouse</option>
                            <option value="lever">Lever</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid gap-6">
                <template x-for="job in allJobs" :key="job.id">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900" x-text="job.title"></h3>
                                    <span x-show="job.is_joborra_job" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Joborra Job</span>
                                    <span x-show="job.visa_sponsorship" class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Visa Friendly</span>
                                </div>
                                <p class="text-gray-600 mb-2" x-text="job.company?.name || 'Unknown Company'"></p>
                                <p class="text-sm text-gray-500 mb-2" x-text="job.location"></p>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span x-text="job.source_website"></span>
                                    <span x-show="job.employment_type" x-text="job.employment_type"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function employerDashboard() {
            return {
                user: null,
                activeTab: 'jobs',
                loading: false,
                error: '',
                myJobs: [],
                allJobs: [],
                searchTimeout: null,
                browseTimeout: null,
                
                jobForm: {
                    title: '',
                    description: '',
                    city: '',
                    state: '',
                    salary_min: null,
                    salary_max: null,
                    employment_type: '',
                    remote_option: false,
                    visa_sponsorship: false,
                    international_student_friendly: false,
                    required_skills: [],
                    preferred_skills: []
                },
                
                requiredSkillsText: '',
                preferredSkillsText: '',
                
                browseFilters: {
                    search: '',
                    location: '',
                    source: ''
                },
                
                async init() {
                    const token = localStorage.getItem('access_token');
                    const userData = localStorage.getItem('user');
                    
                    if (!token || !userData) {
                        window.location.href = '/dashboard/auth.html';
                        return;
                    }
                    
                    this.user = JSON.parse(userData);
                    
                    if (this.user.role !== 'employer') {
                        window.location.href = '/dashboard/student-dashboard.html';
                        return;
                    }
                    
                    await this.loadMyJobs();
                },
                
                async loadMyJobs() {
                    try {
                        const token = localStorage.getItem('access_token');
                        const response = await fetch('/auth/employer/jobs', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            this.myJobs = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading jobs:', error);
                    }
                },
                
                async createJob() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        // Parse skills
                        this.jobForm.required_skills = this.requiredSkillsText ? 
                            this.requiredSkillsText.split(',').map(s => s.trim()).filter(s => s) : [];
                        this.jobForm.preferred_skills = this.preferredSkillsText ? 
                            this.preferredSkillsText.split(',').map(s => s.trim()).filter(s => s) : [];
                        
                        // Set location
                        this.jobForm.location = [this.jobForm.city, this.jobForm.state].filter(x => x).join(', ');
                        
                        const token = localStorage.getItem('access_token');
                        const response = await fetch('/auth/employer/jobs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.jobForm)
                        });
                        
                        if (response.ok) {
                            await this.loadMyJobs();
                            this.resetForm();
                            this.activeTab = 'jobs';
                            alert('Job posted successfully!');
                        } else {
                            const data = await response.json();
                            this.error = data.detail || 'Failed to create job';
                        }
                    } catch (error) {
                        this.error = 'Network error. Please try again.';
                        console.error('Error creating job:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async toggleJobStatus(job) {
                    try {
                        const token = localStorage.getItem('access_token');
                        const response = await fetch(`/auth/employer/jobs/${job.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                is_active: !job.is_active
                            })
                        });
                        
                        if (response.ok) {
                            await this.loadMyJobs();
                        }
                    } catch (error) {
                        console.error('Error updating job:', error);
                    }
                },
                
                async deleteJob(jobId) {
                    if (!confirm('Are you sure you want to delete this job?')) return;
                    
                    try {
                        const token = localStorage.getItem('access_token');
                        const response = await fetch(`/auth/employer/jobs/${jobId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            await this.loadMyJobs();
                        }
                    } catch (error) {
                        console.error('Error deleting job:', error);
                    }
                },
                
                async loadAllJobs() {
                    try {
                        const params = new URLSearchParams({
                            page: 1,
                            per_page: 20
                        });
                        
                        if (this.browseFilters.search) params.append('search', this.browseFilters.search);
                        if (this.browseFilters.location) params.append('location', this.browseFilters.location);
                        if (this.browseFilters.source) params.append('source_website', this.browseFilters.source);
                        
                        const response = await fetch(`/jobs/search?${params}`);
                        const data = await response.json();
                        
                        this.allJobs = data.jobs;
                    } catch (error) {
                        console.error('Error loading all jobs:', error);
                    }
                },
                
                debounceBrowseSearch() {
                    clearTimeout(this.browseTimeout);
                    this.browseTimeout = setTimeout(() => {
                        this.loadAllJobs();
                    }, 500);
                },
                
                resetForm() {
                    this.jobForm = {
                        title: '',
                        description: '',
                        city: '',
                        state: '',
                        salary_min: null,
                        salary_max: null,
                        employment_type: '',
                        remote_option: false,
                        visa_sponsorship: false,
                        international_student_friendly: false,
                        required_skills: [],
                        preferred_skills: []
                    };
                    this.requiredSkillsText = '';
                    this.preferredSkillsText = '';
                    this.error = '';
                },
                
                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user');
                    window.location.href = '/dashboard/auth.html';
                }
            }
        }
    </script>
</body>
</html>
